<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Snow Demos</title>
    <style type="text/css">
      body {
        margin: 0;
        font-size: 20px;
      }
      .video {
          width: 25%
      }
      .ui {
        position: absolute;
        left: 5px;
        bottom: 5px;
        z-index:100;
      }
      .ui1 {
        position: absolute;
        left: 5px;
        bottom: 40px;
        z-index:100;
      }
      .ui2 {
        position: absolute;
        left: 105px;
        bottom: 40px;
        z-index:100;
      }
      .ui3 {
        position: absolute;
        left: 205px;
        bottom: 40px;
        z-index:100;
      }
      .pip {
	visibility: hidden;
      }
      .elapsed {
        position: absolute;
        left: 85px;
        bottom: 5px;
        z-index:100;
      }

      .link-to-download {
        position: absolute;
        right: 5px;
        bottom: 5px;
        z-index:100;
      }
    </style>
    <script src="/socket.io/socket.io.js"></script>
    <script type="text/javascript" src="js/video-stream-merger.js"></script>
    <script type="text/javascript" src="js/merger.js"></script>
    <script type="text/javascript" src="js/stats.js"></script>
    <script type="text/javascript" src="js/snow.js"></script>
    <script type="text/javascript" src="js/snowbase.js"></script>
    <script type="text/javascript" src="js/snowmesh.js"></script>
    <script type="text/javascript" src="js/snowsfu.js"></script>
    <script type="text/javascript" src="js/snowmcu.js"></script>
    <script type="text/javascript" src="js/snowmcutwo.js"></script>
    <script type="text/javascript" src="js/snowmcumulti.js"></script>
    <script>
      const socket = io()
      const mediaConstraints = {
        audio: true,
        video: { width: 1280, height: 720 },
      }
      const iceServers = {
       iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' },
        { urls: 'stun:stun2.l.google.com:19302' },
        { urls: 'stun:stun3.l.google.com:19302' },
        { urls: 'stun:stun4.l.google.com:19302' }
       ],
      }; 

      function getRoom() {
        const urlParams = new URLSearchParams(window.location.search);
        let room = urlParams.get('room');
        if (room == null) {
           room = "demo";
        }
        return room;
      }
      var snow = null;
      function init(model) {
        snow = new Snow(model, {
               "stats": "stats",
               "localVideo": "local-video",
               "remoteVideos": ["remote-video1","remote-video2"],
               "mediaConstraints": mediaConstraints,
               "iceServers": iceServers,
               "socket": socket});
        snow.joinRoom(getRoom());

        video = document.getElementById("remote-video1");
        video.addEventListener('loadedmetadata', function() {
            console.log('Remote video videoWidth: ' + this.videoWidth +
              'px,  videoHeight: ' + this.videoHeight + 'px');
        });
	
	video.onresize = function() {
            console.log('Remote video size changed to ' +
             video.videoWidth + 'x' + video.videoHeight);
	    video.style.width = '' + video.videoWidth + 'px';
	    
	};



      }
      function startCall() {
          let model = document.getElementById("model").value;
	  if (model == "MCUTwo") {
             document.getElementById("pip1").classList.remove("pip");
             document.getElementById("pip2").classList.remove("pip");
             document.getElementById("pip3").classList.remove("pip");
	  } 
          init(model);
      }
      function hangUp() {
        if (snow != null) {
          snow.hangUp();
        }
      }
      var old_height1 = null;
      var old_width1 = null;
      var old_height2 = null;
      var old_width2 = null;
      function pip1() {
	  if (old_height1 == null) {
	    old_height1 = snow.model.merger1.merger._streams[1].height;
	    old_width1 = snow.model.merger1.merger._streams[1].width;
	    snow.model.merger1.merger._streams[1].height = old_height1/2;
	    snow.model.merger1.merger._streams[1].width = old_width1/2;
	    snow.model.merger1.merger._streams[1].x = snow.model.merger1.merger._streams[1].x/2; 
            snow.model.merger1.merger._canvas.width = snow.model.merger1.merger._canvas.width/2;
	  }
      }
      function pip2() {
	  if (old_height2 == null) {
	    old_height2 = snow.model.merger2.merger._streams[1].height;
	    old_width2 = snow.model.merger2.merger._streams[1].width;
	    snow.model.merger2.merger._streams[1].height = old_height2/2;
	    snow.model.merger2.merger._streams[1].width = old_width2/2;
	    snow.model.merger2.merger._streams[1].x = snow.model.merger2.merger._streams[1].x/2; 
            snow.model.merger2.merger._canvas.width = snow.model.merger2.merger._canvas.width/2;
	  }
      }
      function pipreset() {
          if (old_height1 != null) {
	    snow.model.merger1.merger._streams[1].height = old_height1;
	    snow.model.merger1.merger._streams[1].width = old_width1;
	    snow.model.merger1.merger._streams[1].x = snow.model.merger1.merger._streams[1].x*2; 
            snow.model.merger1.merger._canvas.width = snow.model.merger1.merger._canvas.width*2;
	    old_height1 = null;
          }
          if (old_height2 != null) {
	    snow.model.merger2.merger._streams[1].height = old_height2;
	    snow.model.merger2.merger._streams[1].width = old_width2;
	    snow.model.merger2.merger._streams[1].x = snow.model.merger2.merger._streams[1].x*2; 
            snow.model.merger2.merger._canvas.width = snow.model.merger2.merger._canvas.width*2;
	    old_height2 = null;
	  }
      }
      function onLoad() {
         document.getElementById("download").addEventListener("click", function (event) {
           console.log("downloading stats");
           this.href = "data:application/json," + escape(localStorage.getItem("stats"));
         },false);
      }
    </script>
  </head>
  <body onload="onLoad()">
    <div>
      <select id="model">
        <option name="Mesh" value="Mesh">Mesh</option>
        <option name="SFU" value="SFU">SFU</option>
        <option name="MCU" value="MCU">MCU</option>
        <option name="MCUTwo" value="MCUTwo">MCUTwo</option>
        <option name="MCUMulti" value="MCUMulti">MCUMulti</option>
      </select>
      <button onclick="startCall()">Start</button>
    </div>
    <div>
      <video id="local-video" autoplay="autoplay" muted="muted" class="video"></video>
      <video id="remote-video1" autoplay="autoplay" class="video"></video>
      <video id="remote-video2" autoplay="autoplay" class="video"></video>
    </div>
    <button id="pip1" class="ui1 pip" onclick="pip1()">PiP Stream 1</button><br>
    <button id="pip2" class="ui2 pip" onclick="pip2()">PiP Stream 2</button><br>
    <button id="pip3" class="ui3 pip" onclick="pipreset()">PiP Reset</button>
    <button class="ui" onclick="hangUp()">Hang Up</button>
    <div id="seconds" class="elapsed"></div>
    <a id="download" class="link-to-download" href="download" download="stats.json">Export Stats</a>

    <br>
    <div id="stats"></div>
  </body>
</html>
